<!DOCTYPE html>
<html>
  <head>
    <script src="scripts/header.js"></script>
    <!-- EXTERNAL LIBS-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://www.google.com/jsapi"></script>
    <script>
      // onload callback
      function drawCharts(hours) {

        var startDate;
        var endDate;
        var max_pressure = 0.0;
        var min_pressure = 100.0;
        var dataPoints=hours*30;

        var public_key = 'aG7gpV9D0ACNGj74OJqd';

        /* JSONP request grab up to 24 hours worth of data. */

        var jsonData = $.ajax({
          url: 'https://data.sparkfun.com/output/' + public_key + '?limit=' + dataPoints +'.json',
          dataType: 'jsonp',
        }).done(function (results) {

          /* Setup the data structures for the graphs. */

          var dataHumidity = google.visualization.arrayToDataTable([
            ['Sensor', 'Value'],
            ['Humidity', parseFloat(results[0].h_ap)],
          ]);
          
          var dataTemperature = google.visualization.arrayToDataTable([
            ['Sensor', 'Value'],
            ['Temperature', parseFloat(results[0].t_df)],
          ]);
          
          var dataPressure = google.visualization.arrayToDataTable([
            ['Sensor', 'Value'],
            ['Pressure', parseFloat(results[0].p_in)],
          ]);
          
          var pressureChartData = new google.visualization.DataTable();

          pressureChartData.addColumn('datetime', 'Time');
          pressureChartData.addColumn('number', 'Pressure (inHg)');

          var temperatureHumidityData = new google.visualization.DataTable();

          temperatureHumidityData.addColumn('datetime', 'Time');
          temperatureHumidityData.addColumn('number', 'Temperature (F)');
          temperatureHumidityData.addColumn('number', 'Humidity (r%)');
          
          /* Loop through the returned data and fill in the data structures
           * defined above.
           */
           
          $.each(results, function (i, row) {
            
            if (i == 0)
            {
              startDate = new Date(row.timestamp);
            }

            endDate = new Date(row.timestamp);

            pressureChartData.addRow([
              (new Date(row.timestamp)),
              parseFloat(row.p_in)
            ]);
            max_pressure = Math.max(max_pressure,parseFloat(row.p_in));
            min_pressure = Math.min(min_pressure,parseFloat(row.p_in));

            temperatureHumidityData.addRow([
              (new Date(row.timestamp)),
              parseFloat(row.t_df),
              parseFloat(row.h_ap)
            ]);          
          });

          /* Create the graphs and apply formatting to them. */

          var optionsHumidity = {
            width: 800, height: 250,
            min: 0, max: 100,
            greenFrom: 40, greedTo: 60,
            redColor: '#66ff66',
            redFrom: 35, redTo: 65,
            //yellowFrom:75, yellowTo: 90,
            minorTicks: 5
          };
          
          var optionsPressure = {
            width: 800, height: 250,
            min: 28, max: 31,
            redFrom: max_pressure, redTo: max_pressure + 0.025,
            yellowFrom: min_pressure, yellowTo: max_pressure,
            minorTicks: 5
          };
          
          var optionsTemperature = {
            width: 800, height: 250,
            min: 0, max: 100,
            redColor: '#33adff', // Medium Blue
            redFrom: 0, redTo: 32,
            yellowColor: '#33ffff', // Light Blue
            yellowFrom: 32, yellowTo: 35,
            minorTicks: 5
          };
                    
          var chartHumidity = new google.visualization.Gauge($('#gaugeHumidity').get(0));
          chartHumidity.draw(dataHumidity, optionsHumidity);

          var chartTemperature = new google.visualization.Gauge($('#gaugeTemperature').get(0));
          chartTemperature.draw(dataTemperature, optionsTemperature);

          var chartPressure = new google.visualization.Gauge($('#gaugePressure').get(0));
          chartPressure.draw(dataPressure, optionsPressure);
          
          var pressureChart = new google.visualization.LineChart($('#pressureChart').get(0));
          pressureChart.draw(pressureChartData, {
            width: window.innerWidth * 0.8,
            height: 250,
            legend: {position: 'bottom'},
            title: 'Pressure [' + endDate.toLocaleString() + '] to [' + startDate.toLocaleString() +']',
            chartArea: { width: '90%', height: '70%' },
            hAxis: { viewWindow: { min: startDate, max: endDate },
                     gridlines: { count: -1, units: { hours: { format: ['dd MMM HH:mm'] }}},
                     minorGridlines: { units: { hours: { format: ['HH:mm:ss a'] }}}}
          });

          var temperatureHumidityChart = new google.visualization.LineChart($('#temperatureHumidityChart').get(0));
          temperatureHumidityChart.draw(temperatureHumidityData, {
            width: window.innerWidth * 0.8,
            height: 250,
            legend: {position: 'bottom'},
            title: 'Temperature and Humidity [' + endDate.toLocaleString() + '] to [' + startDate.toLocaleString() +']',
            chartArea: { width: '90%', height: '70%' },
            hAxis: { viewWindow: { min: startDate, max: endDate },
                     gridlines: { count: -1, units: { hours: { format: ['dd MMM HH:mm'] }}},
                     minorGridlines: { units: { hours: { format: ['HH:mm:ss a'] }}}}
          });
        });
      }
      // load chart lib
      google.load('visualization', '1', {
        packages: ['corechart','gauge']
      });
      // call drawChart once google charts is loaded
      google.setOnLoadCallback(drawCharts(24));
    </script>
  </head>
  <body>
    <div id="headerHTML"></div>
    <hr width="80%" align=center>
    <table width="80%" align=center>
      <tr>
        <td><form><input type="text" value="24" id="dataVal"> Hours</form></td>
        <td><button type="button" onclick="drawCharts(document.getElementById('dataVal').value)">Redraw</button></td>
      </tr>
    </table>
    <hr width="80%" align=center>
    <table width="80%" align=center>
       <tr>
         <td><div id="gaugeHumidity" style="width: 25%;"></div></td>
         <td><div id="gaugePressure" style="width: 25%;"></div></td>
         <td><div id="gaugeTemperature" style="width: 25%;"></div></td>
       </tr>
    </table>
    <table width="80%" align=center>
       <tr align=center>
         <td><div id="pressureChart" style="width: 100%;"></div></td>
       </tr>
    </table>

    <table width="80%" align=center>
       <tr align=center>
         <td><div id="temperatureHumidityChart" style="width: 100%;"></div></td>
       </tr>
    </table>

  </body>
  <script>
  function autoDraw() {drawCharts(document.getElementById('dataVal').value);}
  window.setInterval(autoDraw,300000);
  </script>
  <script>
  $('#headerHTML').html(header());
  </script>
</html>



